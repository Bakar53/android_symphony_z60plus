on early-init
    write /sys/class/graphics/fb0/modes "U:720x1600p60-0"
    write /sys/class/graphics/fb0/mode "U:720x1600p60-0"
    write /sys/class/graphics/fb0/blank 0
    chmod 0666 /sys/class/graphics/fb0/blank
    chmod 0666 /sys/class/graphics/fb0/mode
    chmod 0666 /sys/class/graphics/fb0/modes
    write /dev/kmsg "TWRP: Setting up framebuffer"
    
    # Mount critical filesystems early
    mkdir /vendor 0771 system system
    mount tmpfs tmpfs /vendor mode=0771,uid=0,gid=0
    restorecon_recursive /vendor
    
    # Load available display/graphics modules in proper order
    insmod /vendor_dlkm/lib/modules/pinctrl.ko
    insmod /vendor_dlkm/lib/modules/pinctrl-sprd.ko
    insmod /vendor_dlkm/lib/modules/pinctrl-sprd-qogirl6.ko
    insmod /vendor_dlkm/lib/modules/apsys-dvfs.ko
    insmod /vendor_dlkm/lib/modules/sprd-drm.ko
    insmod /vendor_dlkm/lib/modules/sprd-gsp.ko
    insmod /vendor_dlkm/lib/modules/sprd_mipi.ko
    insmod /vendor_dlkm/lib/modules/mipi_driver.ko

on init
    # Create mount points for debug
    mkdir /data 0771 system system
    mkdir /cache 0770 system cache
    write /dev/kmsg "TWRP Debug: Created mount points"

on fs
    write /dev/kmsg "TWRP Debug: Starting fs phase"
    mkdir /dev/graphics 0770 system graphics
    chmod 0666 /dev/graphics/fb0
    chown system graphics /dev/graphics/fb0
    
    # Mount logical partitions with correct slot
    mount erofs /dev/block/mapper/system_a / ro
    mount erofs /dev/block/mapper/vendor_a /vendor ro
    mount erofs /dev/block/mapper/product_a /product ro
    mount ext4 /dev/block/mapper/vendor_dlkm_a /vendor_dlkm ro
    
    # Load only available GPU module
    insmod /vendor_dlkm/lib/modules/mali_kbase.ko
    
    write /dev/kmsg "TWRP Debug: Set up graphics nodes and mounted partitions"

on post-fs
    write /dev/kmsg "TWRP Debug: post-fs started"
    # Debug: list loaded modules
    exec u:r:recovery:s0 -- /system/bin/sh -c "lsmod > /cache/twrp/loaded_modules.txt"
    exec u:r:recovery:s0 -- /system/bin/sh -c "ls -l /dev/graphics/* > /cache/twrp/graphics_nodes.txt"
    
on post-fs-data
    write /dev/kmsg "TWRP Debug: post-fs-data started"
    # Log current display state
    exec u:r:recovery:s0 -- /system/bin/sh -c "cat /sys/class/graphics/fb0/mode >> /cache/twrp/display_state.txt"
    exec u:r:recovery:s0 -- /system/bin/sh -c "cat /sys/class/graphics/fb0/blank >> /cache/twrp/display_state.txt"
    exec u:r:recovery:s0 -- /system/bin/sh -c "ls -l /vendor_dlkm/lib/modules/ >> /cache/twrp/modules_available.txt"